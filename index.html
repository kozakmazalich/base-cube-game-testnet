<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Base Cube Game - Win $BASE</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: #0a0e17;
      overflow: hidden;
      position: relative;
      font-family: system-ui, -apple-system, sans-serif;
      gap: 60px;
      padding: 20px;
    }

    /* –ü–∏–∫—Å–µ–ª—å–Ω—ã–π —Ñ–æ–Ω —Å —Ü–≤–µ—Ç–∞–º–∏ Base.org */
    .pixel-bg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      display: grid;
      grid-template-columns: repeat(40, 1fr);
      grid-template-rows: repeat(40, 1fr);
      gap: 2px;
      padding: 10px;
    }

    .pixel {
      background: rgba(0, 82, 255, 0.05);
      border-radius: 1px;
      aspect-ratio: 1/1;
      animation: pixelGlow 12s infinite ease-in-out;
    }

    @keyframes pixelGlow {
      0%, 85% {
        background: rgba(0, 82, 255, 0.05);
        box-shadow: 0 0 1px rgba(0, 82, 255, 0);
      }
      90% {
        background: rgba(0, 82, 255, 0.3);
        box-shadow: 0 0 6px rgba(255, 255, 255, 0.8);
      }
      95% {
        background: rgba(255, 255, 255, 0.6);
        box-shadow: 0 0 8px rgba(255, 255, 255, 1);
      }
      100% {
        background: rgba(0, 82, 255, 0.05);
        box-shadow: 0 0 1px rgba(0, 82, 255, 0);
      }
    }

    .scene {
      width: 200px;
      height: 200px;
      perspective: 1000px;
    }

    .cube {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      transform: rotateX(15deg) rotateY(15deg);
    }

    .face {
      position: absolute;
      width: 200px;
      height: 200px;
      border-radius: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 60px;
      font-weight: 700;
      color: white;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
      box-shadow: 
        0 0 25px rgba(0, 82, 255, 0.6),
        inset 0 0 40px rgba(255, 255, 255, 0.15);
      background: linear-gradient(135deg, rgba(0, 82, 255, 0.9) 0%, rgba(0, 112, 255, 0.9) 100%);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .front  { transform: rotateY(0deg) translateZ(100px); }
    .back   { transform: rotateY(180deg) translateZ(100px); }
    .right  { transform: rotateY(90deg) translateZ(100px); }
    .left   { transform: rotateY(-90deg) translateZ(100px); }
    .top    { transform: rotateX(90deg) translateZ(100px); }
    .bottom { transform: rotateX(-90deg) translateZ(100px); }

    /* –ö–Ω–æ–ø–∫–∞ Roll —Å —Ü–≤–µ—Ç–∞–º–∏ Base.org */
    .roll-btn {
      padding: 16px 40px;
      font-size: 18px;
      font-weight: 600;
      background: linear-gradient(135deg, #0052FF 0%, #0070FF 100%);
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 10px 25px rgba(0, 82, 255, 0.4);
      transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
      position: relative;
      overflow: hidden;
      letter-spacing: 0.5px;
      margin-top: 30px;
    }

    .roll-btn:hover {
      transform: translateY(-4px);
      box-shadow: 0 15px 30px rgba(0, 82, 255, 0.6);
      background: linear-gradient(135deg, #0070FF 0%, #0088FF 100%);
    }

    .roll-btn:active {
      transform: translateY(2px);
      box-shadow: 0 5px 15px rgba(0, 82, 255, 0.4);
    }

    .roll-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.6s;
    }

    .roll-btn:hover::before {
      left: 100%;
    }

    .roll-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* Wallet Connect Button */
    .connect-btn {
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      background: linear-gradient(135deg, #0052FF 0%, #0070FF 100%);
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(0, 82, 255, 0.3);
      transition: all 0.3s ease;
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 1000;
    }

    .connect-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 25px rgba(0, 82, 255, 0.5);
    }

    .connect-btn.connected {
      background: linear-gradient(135deg, #00C851 0%, #00E676 100%);
      box-shadow: 0 8px 20px rgba(0, 200, 81, 0.3);
    }

    /* Claim Button */
    .claim-btn {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: black;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 6px 15px rgba(255, 215, 0, 0.4);
      transition: all 0.3s ease;
      margin-top: 10px;
    }

    .claim-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(255, 215, 0, 0.6);
    }

    .claim-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* Game Mode Indicator */
    .game-mode {
      position: absolute;
      top: 80px;
      left: 20px;
      background: rgba(0, 82, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 10px 15px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: white;
      font-size: 12px;
      box-shadow: 0 4px 15px rgba(0, 82, 255, 0.2);
      z-index: 1000;
    }

    .mode-onchain {
      color: #00E676;
      font-weight: 600;
    }

    /* –°–∞–ª—é—Ç —Å —Ü–≤–µ—Ç–∞–º–∏ Base.org */
    .firework {
      position: absolute;
      pointer-events: none;
      z-index: 100;
    }

    .particle {
      position: absolute;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      animation: firework 1.5s ease-out forwards;
    }

    @keyframes firework {
      0% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
      50% {
        opacity: 1;
      }
      100% {
        transform: translate(var(--tx), var(--ty)) scale(0);
        opacity: 0;
      }
    }

    .win-glow {
      animation: winGlow 2s ease-in-out;
    }

    @keyframes winGlow {
      0%, 100% {
        box-shadow: 
          0 0 25px rgba(0, 82, 255, 0.6),
          inset 0 0 40px rgba(255, 255, 255, 0.15);
      }
      50% {
        box-shadow: 
          0 0 50px rgba(255, 255, 255, 0.9),
          0 0 80px rgba(0, 82, 255, 0.8),
          inset 0 0 60px rgba(255, 255, 255, 0.4);
      }
    }

    /* –¢–∞–±–ª–∏—Ü–∞ –Ω–∞–≥—Ä–∞–¥ */
    .rewards-table {
      background: rgba(0, 82, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 25px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: 0 10px 30px rgba(0, 82, 255, 0.2);
      min-width: 250px;
    }

    .rewards-table h3 {
      color: white;
      text-align: center;
      margin-bottom: 20px;
      font-size: 20px;
      font-weight: 600;
    }

    .reward-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
    }

    .reward-item:last-child {
      border-bottom: none;
    }

    .reward-symbol {
      font-size: 24px;
      margin-right: 15px;
    }

    .reward-text {
      flex: 1;
      font-size: 16px;
      font-weight: 500;
    }

    .reward-tokens {
      background: linear-gradient(135deg, #0052FF, #0070FF);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
    }

    .game-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .game-cost {
      color: white;
      font-size: 14px;
      margin-top: 10px;
      opacity: 0.8;
    }

    .token-balance {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: rgba(0, 82, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 15px 20px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: white;
      font-size: 14px;
      box-shadow: 0 8px 25px rgba(0, 82, 255, 0.2);
      text-align: center;
    }

    .balance {
      font-weight: 600;
      margin-top: 5px;
      color: #FFD700;
    }

    .transaction-status {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 82, 255, 0.9);
      color: white;
      padding: 12px 24px;
      border-radius: 25px;
      font-weight: 600;
      z-index: 1000;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 25px rgba(0, 82, 255, 0.4);
      text-align: center;
      max-width: 400px;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      body {
        flex-direction: column;
        gap: 30px;
        padding: 10px;
      }
      
      .scene {
        width: 150px;
        height: 150px;
      }
      
      .face {
        width: 150px;
        height: 150px;
        font-size: 40px;
      }
      
      .front  { transform: rotateY(0deg) translateZ(75px); }
      .back   { transform: rotateY(180deg) translateZ(75px); }
      .right  { transform: rotateY(90deg) translateZ(75px); }
      .left   { transform: rotateY(-90deg) translateZ(75px); }
      .top    { transform: rotateX(90deg) translateZ(75px); }
      .bottom { transform: rotateX(-90deg) translateZ(75px); }
      
      .rewards-table {
        min-width: 200px;
        padding: 15px;
      }
      
      .connect-btn {
        position: relative;
        top: 0;
        left: 0;
        margin-bottom: 20px;
      }
      
      .game-mode {
        position: relative;
        top: 0;
        left: 0;
        margin-bottom: 10px;
      }
    }
  </style>
</head>
<body>
  <button class="connect-btn" id="connectBtn">Connect Wallet</button>
  <div class="game-mode" id="gameMode">Mode: <span class="mode-onchain">On-Chain</span></div>

  <div class="token-balance">
    <div>$BASE Balance: <span id="tokenBalance">0</span></div>
    <div class="balance">Wallet: <span id="walletAddress">Not connected</span></div>
    <div class="balance">Game Balance: <span id="gameBalance">0</span></div>
    <button class="claim-btn" id="claimBtn" disabled>Claim Rewards</button>
  </div>

  <div class="rewards-table">
    <h3>Rewards</h3>
    <div class="reward-item">
      <span class="reward-symbol">üíé</span>
      <span class="reward-text">1 base token</span>
      <span class="reward-tokens">+1</span>
    </div>
    <div class="reward-item">
      <span class="reward-symbol">‚≠ê</span>
      <span class="reward-text">3 base tokens</span>
      <span class="reward-tokens">+3</span>
    </div>
    <div class="reward-item">
      <span class="reward-symbol">üèÜ</span>
      <span class="reward-text">5 base tokens</span>
      <span class="reward-tokens">+5</span>
    </div>
  </div>

  <div class="game-container">
    <div class="scene">
      <div class="cube" id="cube">
        <div class="face front">üèÜ</div>
        <div class="face back">‚ùå</div>
        <div class="face right">üíé</div>
        <div class="face left">‚≠ê</div>
        <div class="face top">‚ùå</div>
        <div class="face bottom">‚ùå</div>
      </div>
    </div>

    <button class="roll-btn" id="rollBtn" disabled>ROLL</button>
    <div class="game-cost">Free to play!</div>
  </div>

  <div class="pixel-bg" id="pixelBg"></div>
  <div class="firework" id="firework"></div>

  <!-- Ethers.js for blockchain interaction -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  
  <script>
    // Contract addresses for Base Sepolia (UPDATE THESE AFTER DEPLOYMENT)
    const TOKEN_CONTRACT_ADDRESS = "0xBEDe39E8c95E8FAFe1cdb0c256D35A2c894180fb";
    const GAME_CONTRACT_ADDRESS = "0x79f550C69a2263051b17Eea301aFc97D8617132F";
    
    // Base Sepolia network configuration
    const BASE_SEPOLIA_CHAIN_ID = '0x14a34';
    const BASE_SEPOLIA_RPC_URL = 'https://sepolia.base.org';
    
    // DOM Elements
    const tokenBalanceElement = document.getElementById('tokenBalance');
    const gameBalanceElement = document.getElementById('gameBalance');
    const walletAddressElement = document.getElementById('walletAddress');
    const rollBtn = document.getElementById('rollBtn');
    const connectBtn = document.getElementById('connectBtn');
    const claimBtn = document.getElementById('claimBtn');
    const gameModeElement = document.getElementById('gameMode');

    let provider;
    let signer;
    let tokenContract;
    let gameContract;
    let userAddress;

    // ABI for ERC20 token
    const tokenAbi = [
      "function balanceOf(address) view returns (uint256)",
      "function transfer(address to, uint256 amount) returns (bool)",
      "function decimals() view returns (uint8)",
      "function symbol() view returns (string)",
      "function approve(address spender, uint256 amount) returns (bool)"
    ];

    // ABI for game contract
    const gameAbi = [
      "function playGame() returns (uint256)",
      "function getLastResult(address) view returns (uint256)",
      "function players(address) view returns (uint256 lastPlayed, uint256 totalWins, uint256 totalTokensWon, uint256 balance)",
      "function claimRewards()",
      "function getPlayerInfo(address) view returns (uint256 lastPlayed, uint256 totalWins, uint256 totalTokensWon, uint256 balance, uint256 lastResult)"
    ];

    // Initialize the game
    async function initializeGame() {
      console.log('Initializing Base Cube Game...');
      
      setupGameVisuals();
      setupWalletConnection();
      
      // Check if wallet is already connected
      if (typeof window.ethereum !== 'undefined') {
        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
        if (accounts.length > 0) {
          await initializeWallet();
        }
      }
    }

    function setupGameVisuals() {
      const pixelBg = document.getElementById('pixelBg');
      const pixelCount = 1600;
      
      for (let i = 0; i < pixelCount; i++) {
        const pixel = document.createElement('div');
        pixel.classList.add('pixel');
        pixel.style.animationDelay = `${Math.random() * 15}s`;
        pixel.style.animationDuration = `${10 + Math.random() * 8}s`;
        pixelBg.appendChild(pixel);
      }

      const cube = document.getElementById('cube');
      cube.style.opacity = '0';
      cube.style.transform = 'rotateX(15deg) rotateY(15deg) scale(0.8)';
      
      setTimeout(() => {
        cube.style.transition = 'all 1.2s ease-out';
        cube.style.opacity = '1';
        cube.style.transform = 'rotateX(15deg) rotateY(15deg) scale(1)';
      }, 300);
    }

    function setupWalletConnection() {
      connectBtn.addEventListener('click', connectWallet);
      claimBtn.addEventListener('click', claimRewards);
    }

    async function connectWallet() {
      try {
        if (typeof window.ethereum === 'undefined') {
          showTransactionStatus('Please install MetaMask!');
          return;
        }

        showTransactionStatus('Connecting wallet...');
        await window.ethereum.request({ method: 'eth_requestAccounts' });
        await initializeWallet();
        
      } catch (error) {
        console.error('Error connecting wallet:', error);
        showTransactionStatus('Error: ' + (error.message || 'User rejected connection'));
      }
    }

    async function initializeWallet() {
      try {
        const chainId = await window.ethereum.request({ method: 'eth_chainId' });
        
        if (chainId !== BASE_SEPOLIA_CHAIN_ID) {
          await switchToBaseSepolia();
          return;
        }

        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        
        // Initialize contracts
        tokenContract = new ethers.Contract(0xBEDe39E8c95E8FAFe1cdb0c256D35A2c894180fb, tokenAbi, signer);
        gameContract = new ethers.Contract(0x79f550C69a2263051b17Eea301aFc97D8617132F, gameAbi, signer);
        
        // Update UI
        connectBtn.textContent = 'Connected';
        connectBtn.classList.add('connected');
        walletAddressElement.textContent = `${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
        rollBtn.disabled = false;
        
        // Load balances
        await loadBalances();
        
        showTransactionStatus('Wallet connected! On-chain mode active.');
        
        // Set up event listeners
        window.ethereum.on('accountsChanged', handleAccountsChanged);
        window.ethereum.on('chainChanged', handleChainChanged);
        
      } catch (error) {
        console.error('Error initializing wallet:', error);
        showTransactionStatus('Error: ' + error.message);
      }
    }

    async function switchToBaseSepolia() {
      try {
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: BASE_SEPOLIA_CHAIN_ID }],
        });
      } catch (switchError) {
        if (switchError.code === 4902) {
          await window.ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [{
              chainId: BASE_SEPOLIA_CHAIN_ID,
              chainName: 'Base Sepolia',
              rpcUrls: [BASE_SEPOLIA_RPC_URL],
              nativeCurrency: { name: 'Ether', symbol: 'ETH', decimals: 18 },
              blockExplorerUrls: ['https://sepolia.basescan.org'],
            }],
          });
        }
      }
    }

    async function loadBalances() {
      try {
        if (signer && tokenContract && gameContract) {
          // Load token balance
          const tokenBalance = await tokenContract.balanceOf(userAddress);
          const decimals = await tokenContract.decimals();
          const formattedBalance = parseFloat(ethers.utils.formatUnits(tokenBalance, decimals));
          tokenBalanceElement.textContent = formattedBalance.toFixed(2);
          
          // Load game balance
          const playerInfo = await gameContract.getPlayerInfo(userAddress);
          const gameBalance = parseFloat(ethers.utils.formatUnits(playerInfo.balance, decimals));
          gameBalanceElement.textContent = gameBalance.toFixed(2);
          
          // Enable claim button if there are rewards
          claimBtn.disabled = gameBalance <= 0;
        }
      } catch (error) {
        console.error("Error loading balances:", error);
      }
    }

    function handleAccountsChanged(accounts) {
      if (accounts.length === 0) {
        disconnectWallet();
      } else {
        userAddress = accounts[0];
        walletAddressElement.textContent = `${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
        loadBalances();
      }
    }

    function handleChainChanged(chainId) {
      window.location.reload();
    }

    function disconnectWallet() {
      connectBtn.textContent = 'Connect Wallet';
      connectBtn.classList.remove('connected');
      walletAddressElement.textContent = 'Not connected';
      tokenBalanceElement.textContent = '0';
      gameBalanceElement.textContent = '0';
      rollBtn.disabled = true;
      claimBtn.disabled = true;
      userAddress = null;
      showTransactionStatus('Wallet disconnected');
    }

    async function claimRewards() {
      try {
        claimBtn.disabled = true;
        showTransactionStatus('Claiming rewards...');
        
        const tx = await gameContract.claimRewards();
        showTransactionStatus('Transaction submitted...');
        
        const receipt = await tx.wait();
        console.log('Claim successful:', receipt);
        
        showTransactionStatus('üéâ Rewards claimed successfully!');
        await loadBalances();
        
      } catch (error) {
        console.error('Error claiming rewards:', error);
        showTransactionStatus('Error claiming rewards: ' + error.message);
        claimBtn.disabled = false;
      }
    }

    function showTransactionStatus(message) {
      const existingStatus = document.querySelector('.transaction-status');
      if (existingStatus) existingStatus.remove();
      
      const status = document.createElement('div');
      status.className = 'transaction-status';
      status.textContent = message;
      document.body.appendChild(status);
      
      setTimeout(() => status.remove(), 5000);
    }

    // Game cube faces mapping to contract results
    const faceMapping = {
      1: 'üèÜ', // 5 tokens
      2: '‚ùå', // Lose
      3: 'üíé', // 3 tokens  
      4: '‚≠ê', // 1 token
      5: '‚ùå', // Lose
      6: '‚ùå'  // Lose
    };

    const cube = document.getElementById('cube');
    const firework = document.getElementById('firework');
    
    let isSpinning = false;
    
    const stopPositions = [
      { x: 0, y: 0, z: 0, symbol: 'üèÜ' },
      { x: 0, y: 180, z: 0, symbol: '‚ùå' },
      { x: 90, y: 0, z: 0, symbol: '‚ùå' },
      { x: -90, y: 0, z: 0, symbol: '‚ùå' },
      { x: 0, y: 90, z: 0, symbol: 'üíé' },
      { x: 0, y: -90, z: 0, symbol: '‚≠ê' }
    ];
    
    function createFirework(x, y) {
      const colors = ['#0052FF', '#0070FF', '#FFFFFF', '#0088FF', '#E6F0FF', '#B3D4FF'];
      
      for (let i = 0; i < 60; i++) {
        const particle = document.createElement('div');
        particle.classList.add('particle');
        
        const angle = Math.random() * Math.PI * 2;
        const distance = 80 + Math.random() * 120;
        const tx = Math.cos(angle) * distance;
        const ty = Math.sin(angle) * distance;
        const color = colors[Math.floor(Math.random() * colors.length)];
        const size = 3 + Math.random() * 4;
        const duration = 1 + Math.random() * 0.5;
        
        particle.style.left = `${x}px`;
        particle.style.top = `${y}px`;
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        particle.style.background = color;
        particle.style.setProperty('--tx', `${tx}px`);
        particle.style.setProperty('--ty', `${ty}px`);
        particle.style.animationDuration = `${duration}s`;
        
        firework.appendChild(particle);
        setTimeout(() => particle.remove(), duration * 1000);
      }
    }
    
    function createVictoryFireworks() {
      const positions = [
        [window.innerWidth * 0.1, window.innerHeight * 0.1],
        [window.innerWidth * 0.9, window.innerHeight * 0.1],
        [window.innerWidth * 0.1, window.innerHeight * 0.9],
        [window.innerWidth * 0.9, window.innerHeight * 0.9],
        [window.innerWidth * 0.5, window.innerHeight * 0.1],
        [window.innerWidth * 0.5, window.innerHeight * 0.9],
        [window.innerWidth * 0.1, window.innerHeight * 0.5],
        [window.innerWidth * 0.9, window.innerHeight * 0.5]
      ];
      
      positions.forEach(([x, y], index) => {
        setTimeout(() => createFirework(x, y), index * 150);
      });
    }
    
    async function processGameOnChain() {
      try {
        rollBtn.disabled = true;
        showTransactionStatus('Playing game on-chain...');
        
        const tx = await gameContract.playGame();
        showTransactionStatus('Transaction submitted...');
        
        const receipt = await tx.wait();
        console.log('Game played:', receipt);
        
        // Get the result
        const result = await gameContract.getLastResult(userAddress);
        const tokensWon = parseFloat(ethers.utils.formatUnits(result, 18));
        
        if (tokensWon > 0) {
          showTransactionStatus(`üéâ You won ${tokensWon} $BASE tokens!`);
          createVictoryFireworks();
        } else {
          showTransactionStatus('Better luck next time! ‚ùå');
        }
        
        await loadBalances();
        rollBtn.disabled = false;
        
      } catch (error) {
        console.error('Error playing game:', error);
        showTransactionStatus('Error: ' + error.message);
        rollBtn.disabled = false;
      }
    }
    
    function spinCube() {
      if (isSpinning) return;
      
      isSpinning = true;
      rollBtn.disabled = true;
      
      const startX = Math.random() * 360;
      const startY = Math.random() * 360;
      const finalPos = stopPositions[Math.floor(Math.random() * stopPositions.length)];
      
      let startTime = null;
      const totalDuration = 4000;
      const spinDuration = 3000;
      
      function animate(currentTime) {
        if (!startTime) startTime = currentTime;
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / totalDuration, 1);
        
        if (progress < 0.75) {
          const spinProgress = Math.min(elapsed / spinDuration, 1);
          const easeOut = 1 - Math.pow(1 - spinProgress, 3);
          const currentX = startX + (720 * easeOut);
          const currentY = startY + (720 * easeOut);
          cube.style.transform = `rotateX(${currentX}deg) rotateY(${currentY}deg)`;
        } else {
          const slowProgress = (progress - 0.75) / 0.25;
          const easeInOut = slowProgress < 0.5 ? 
            2 * slowProgress * slowProgress : 
            1 - Math.pow(-2 * slowProgress + 2, 2) / 2;
          const currentX = finalPos.x * easeInOut;
          const currentY = finalPos.y * easeInOut;
          cube.style.transform = `rotateX(${currentX}deg) rotateY(${currentY}deg)`;
        }
        
        if (progress < 1) {
          requestAnimationFrame(animate);
        } else {
          cube.style.transform = `rotateX(${finalPos.x}deg) rotateY(${finalPos.y}deg)`;
          
          if (finalPos.symbol !== '‚ùå') {
            const face = cube.getElementsByClassName('face');
            for (let f of face) {
              if (f.textContent === finalPos.symbol) {
                f.classList.add('win-glow');
                setTimeout(() => f.classList.remove('win-glow'), 2000);
                break;
              }
            }
          }
          
          // Call on-chain game function
          processGameOnChain();
          isSpinning = false;
        }
      }
      
      requestAnimationFrame(animate);
    }
    
    rollBtn.addEventListener('click', spinCube);

    // Initialize game
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeGame);
    } else {
      initializeGame();
    }
  </script>
</body>
</html>
