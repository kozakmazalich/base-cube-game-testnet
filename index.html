<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Base Cube Game - Win $BASE</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: #0a0e17;
      overflow: hidden;
      position: relative;
      font-family: system-ui, -apple-system, sans-serif;
      gap: 60px;
      padding: 20px;
    }

    /* Пиксельный фон с цветами Base.org */
    .pixel-bg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      display: grid;
      grid-template-columns: repeat(40, 1fr);
      grid-template-rows: repeat(40, 1fr);
      gap: 2px;
      padding: 10px;
    }

    .pixel {
      background: rgba(0, 82, 255, 0.05);
      border-radius: 1px;
      aspect-ratio: 1/1;
      animation: pixelGlow 12s infinite ease-in-out;
    }

    @keyframes pixelGlow {
      0%, 85% {
        background: rgba(0, 82, 255, 0.05);
        box-shadow: 0 0 1px rgba(0, 82, 255, 0);
      }
      90% {
        background: rgba(0, 82, 255, 0.3);
        box-shadow: 0 0 6px rgba(255, 255, 255, 0.8);
      }
      95% {
        background: rgba(255, 255, 255, 0.6);
        box-shadow: 0 0 8px rgba(255, 255, 255, 1);
      }
      100% {
        background: rgba(0, 82, 255, 0.05);
        box-shadow: 0 0 1px rgba(0, 82, 255, 0);
      }
    }

    .scene {
      width: 200px;
      height: 200px;
      perspective: 1000px;
    }

    .cube {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d;
      transform: rotateX(15deg) rotateY(15deg);
    }

    .face {
      position: absolute;
      width: 200px;
      height: 200px;
      border-radius: 12px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 60px;
      font-weight: 700;
      color: white;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
      box-shadow: 
        0 0 25px rgba(0, 82, 255, 0.6),
        inset 0 0 40px rgba(255, 255, 255, 0.15);
      background: linear-gradient(135deg, rgba(0, 82, 255, 0.9) 0%, rgba(0, 112, 255, 0.9) 100%);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .front  { transform: rotateY(0deg) translateZ(100px); }
    .back   { transform: rotateY(180deg) translateZ(100px); }
    .right  { transform: rotateY(90deg) translateZ(100px); }
    .left   { transform: rotateY(-90deg) translateZ(100px); }
    .top    { transform: rotateX(90deg) translateZ(100px); }
    .bottom { transform: rotateX(-90deg) translateZ(100px); }

    /* Кнопка Roll с цветами Base.org */
    .roll-btn {
      padding: 16px 40px;
      font-size: 18px;
      font-weight: 600;
      background: linear-gradient(135deg, #0052FF 0%, #0070FF 100%);
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 10px 25px rgba(0, 82, 255, 0.4);
      transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
      position: relative;
      overflow: hidden;
      letter-spacing: 0.5px;
      margin-top: 30px;
    }

    .roll-btn:hover {
      transform: translateY(-4px);
      box-shadow: 0 15px 30px rgba(0, 82, 255, 0.6);
      background: linear-gradient(135deg, #0070FF 0%, #0088FF 100%);
    }

    .roll-btn:active {
      transform: translateY(2px);
      box-shadow: 0 5px 15px rgba(0, 82, 255, 0.4);
    }

    .roll-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.6s;
    }

    .roll-btn:hover::before {
      left: 100%;
    }

    .roll-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* Wallet Connect Button */
    .connect-btn {
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      background: linear-gradient(135deg, #0052FF 0%, #0070FF 100%);
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 8px 20px rgba(0, 82, 255, 0.3);
      transition: all 0.3s ease;
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 1000;
    }

    .connect-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 25px rgba(0, 82, 255, 0.5);
    }

    .connect-btn.connected {
      background: linear-gradient(135deg, #00C851 0%, #00E676 100%);
      box-shadow: 0 8px 20px rgba(0, 200, 81, 0.3);
    }

    /* Claim Button */
    .claim-btn {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: black;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 6px 15px rgba(255, 215, 0, 0.4);
      transition: all 0.3s ease;
      margin-top: 10px;
    }

    .claim-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(255, 215, 0, 0.6);
    }

    .claim-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* Game Mode Indicator */
    .game-mode {
      position: absolute;
      top: 80px;
      left: 20px;
      background: rgba(0, 82, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 10px 15px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: white;
      font-size: 12px;
      box-shadow: 0 4px 15px rgba(0, 82, 255, 0.2);
      z-index: 1000;
    }

    .mode-onchain {
      color: #00E676;
      font-weight: 600;
    }

    /* Салют с цветами Base.org */
    .firework {
      position: absolute;
      pointer-events: none;
      z-index: 100;
    }

    .particle {
      position: absolute;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      animation: firework 1.5s ease-out forwards;
    }

    @keyframes firework {
      0% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
      50% {
        opacity: 1;
      }
      100% {
        transform: translate(var(--tx), var(--ty)) scale(0);
        opacity: 0;
      }
    }

    .win-glow {
      animation: winGlow 2s ease-in-out;
    }

    @keyframes winGlow {
      0%, 100% {
        box-shadow: 
          0 0 25px rgba(0, 82, 255, 0.6),
          inset 0 0 40px rgba(255, 255, 255, 0.15);
      }
      50% {
        box-shadow: 
          0 0 50px rgba(255, 255, 255, 0.9),
          0 0 80px rgba(0, 82, 255, 0.8),
          inset 0 0 60px rgba(255, 255, 255, 0.4);
      }
    }

    /* Таблица наград */
    .rewards-table {
      background: rgba(0, 82, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 25px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      box-shadow: 0 10px 30px rgba(0, 82, 255, 0.2);
      min-width: 250px;
    }

    .rewards-table h3 {
      color: white;
      text-align: center;
      margin-bottom: 20px;
      font-size: 20px;
      font-weight: 600;
    }

    .reward-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
    }

    .reward-item:last-child {
      border-bottom: none;
    }

    .reward-symbol {
      font-size: 24px;
      margin-right: 15px;
    }

    .reward-text {
      flex: 1;
      font-size: 16px;
      font-weight: 500;
    }

    .reward-tokens {
      background: linear-gradient(135deg, #0052FF, #0070FF);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
    }

    .game-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .game-cost {
      color: white;
      font-size: 14px;
      margin-top: 10px;
      opacity: 0.8;
    }

    .token-balance {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: rgba(0, 82, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 15px 20px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      color: white;
      font-size: 14px;
      box-shadow: 0 8px 25px rgba(0, 82, 255, 0.2);
      text-align: center;
    }

    .balance {
      font-weight: 600;
      margin-top: 5px;
      color: #FFD700;
    }

    .transaction-status {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 82, 255, 0.9);
      color: white;
      padding: 12px 24px;
      border-radius: 25px;
      font-weight: 600;
      z-index: 1000;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 25px rgba(0, 82, 255, 0.4);
      text-align: center;
      max-width: 400px;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      body {
        flex-direction: column;
        gap: 30px;
        padding: 10px;
      }
      
      .scene {
        width: 150px;
        height: 150px;
      }
      
      .face {
        width: 150px;
        height: 150px;
        font-size: 40px;
      }
      
      .front  { transform: rotateY(0deg) translateZ(75px); }
      .back   { transform: rotateY(180deg) translateZ(75px); }
      .right  { transform: rotateY(90deg) translateZ(75px); }
      .left   { transform: rotateY(-90deg) translateZ(75px); }
      .top    { transform: rotateX(90deg) translateZ(75px); }
      .bottom { transform: rotateX(-90deg) translateZ(75px); }
      
      .rewards-table {
        min-width: 200px;
        padding: 15px;
      }
      
      .connect-btn {
        position: relative;
        top: 0;
        left: 0;
        margin-bottom: 20px;
      }
      
      .game-mode {
        position: relative;
        top: 0;
        left: 0;
        margin-bottom: 10px;
      }
    }
  </style>
</head>
<body>
  <button class="connect-btn" id="connectBtn">Connect Wallet</button>
  <div class="game-mode" id="gameMode">Mode: <span class="mode-onchain">On-Chain</span></div>

  <div class="token-balance">
    <div>$BASE Balance: <span id="tokenBalance">0</span></div>
    <div class="balance">Wallet: <span id="walletAddress">Not connected</span></div>
    <div class="balance">Game Balance: <span id="gameBalance">0</span></div>
    <button class="claim-btn" id="claimBtn" disabled>Claim Rewards</button>
  </div>

  <div class="rewards-table">
    <h3>Rewards</h3>
    <div class="reward-item">
      <span class="reward-symbol">💎</span>
      <span class="reward-text">1 base token</span>
      <span class="reward-tokens">+1</span>
    </div>
    <div class="reward-item">
      <span class="reward-symbol">⭐</span>
      <span class="reward-text">3 base tokens</span>
      <span class="reward-tokens">+3</span>
    </div>
    <div class="reward-item">
      <span class="reward-symbol">🏆</span>
      <span class="reward-text">5 base tokens</span>
      <span class="reward-tokens">+5</span>
    </div>
  </div>

  <div class="game-container">
    <div class="scene">
      <div class="cube" id="cube">
        <div class="face front">🏆</div>
        <div class="face back">❌</div>
        <div class="face right">💎</div>
        <div class="face left">⭐</div>
        <div class="face top">❌</div>
        <div class="face bottom">❌</div>
      </div>
    </div>

    <button class="roll-btn" id="rollBtn" disabled>ROLL</button>
    <div class="game-cost">Free to play!</div>
  </div>

  <div class="pixel-bg" id="pixelBg"></div>
  <div class="firework" id="firework"></div>

  <!-- Ethers.js for blockchain interaction -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  
  <script>
    // Contract addresses - UPDATE THESE WITH YOUR DEPLOYED CONTRACTS
const TOKEN_CONTRACT_ADDRESS = "0xBEDe39E8c95E8FAFe1cdb0c256D35A2c894180fb";
const GAME_CONTRACT_ADDRESS = "0x8b6f5B47109E41476A48D8Bc902A3A405a99BBAB";

// Base Sepolia
const BASE_SEPOLIA_CHAIN_ID = '0x14a34';

// DOM Elements
const tokenBalanceElement = document.getElementById('tokenBalance');
const walletAddressElement = document.getElementById('walletAddress');
const rollBtn = document.getElementById('rollBtn');
const connectBtn = document.getElementById('connectBtn');

let provider, signer, tokenContract, gameContract, userAddress;

// Minimal ABI
const tokenAbi = [
    "function balanceOf(address) view returns (uint256)",
    "function decimals() view returns (uint8)"
];

const gameAbi = [
    "function playGame() returns (uint256)",
    "function getLastResult(address) view returns (uint256)",
    "function playerBalance(address) view returns (uint256)",
    "function claimRewards()",
    "function getGameInfo() view returns (string)"
];

// Initialize
async function initializeGame() {
    setupGameVisuals();
    connectBtn.addEventListener('click', connectWallet);
    rollBtn.addEventListener('click', playGame);
    
    if (typeof window.ethereum !== 'undefined') {
        const accounts = await window.ethereum.request({ method: 'eth_accounts' });
        if (accounts.length > 0) await initializeWallet();
    }
}

function setupGameVisuals() {
    const pixelBg = document.getElementById('pixelBg');
    for (let i = 0; i < 1600; i++) {
        const pixel = document.createElement('div');
        pixel.classList.add('pixel');
        pixel.style.animationDelay = `${Math.random() * 15}s`;
        pixel.style.animationDuration = `${10 + Math.random() * 8}s`;
        pixelBg.appendChild(pixel);
    }
}

async function connectWallet() {
    try {
        if (typeof window.ethereum === 'undefined') {
            alert('Please install MetaMask!');
            return;
        }

        await window.ethereum.request({ method: 'eth_requestAccounts' });
        await initializeWallet();
        
    } catch (error) {
        alert('Error connecting: ' + error.message);
    }
}

async function initializeWallet() {
    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
    
    if (chainId !== BASE_SEPOLIA_CHAIN_ID) {
        try {
            await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: BASE_SEPOLIA_CHAIN_ID }],
            });
        } catch (error) {
            if (error.code === 4902) {
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [{
                        chainId: BASE_SEPOLIA_CHAIN_ID,
                        chainName: 'Base Sepolia',
                        rpcUrls: ['https://sepolia.base.org'],
                        nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                        blockExplorerUrls: ['https://sepolia.basescan.org'],
                    }],
                });
            }
        }
        return;
    }

    provider = new ethers.providers.Web3Provider(window.ethereum);
    signer = provider.getSigner();
    userAddress = await signer.getAddress();
    
    tokenContract = new ethers.Contract(0xBEDe39E8c95E8FAFe1cdb0c256D35A2c894180fb, tokenAbi, signer);
    gameContract = new ethers.Contract(0x8b6f5B47109E41476A48D8Bc902A3A405a99BBAB, gameAbi, signer);
    
    connectBtn.textContent = 'Connected';
    connectBtn.classList.add('connected');
    walletAddressElement.textContent = `${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
    rollBtn.disabled = false;
    
    await loadBalance();
    showStatus('✅ Wallet connected! Ready to play.');
}

async function loadBalance() {
    try {
        const balance = await tokenContract.balanceOf(userAddress);
        const decimals = await tokenContract.decimals();
        const formatted = parseFloat(ethers.utils.formatUnits(balance, decimals));
        tokenBalanceElement.textContent = formatted.toFixed(2);
    } catch (error) {
        console.log("Balance load error:", error);
    }
}

async function playGame() {
    if (!gameContract) return;
    
    rollBtn.disabled = true;
    showStatus('🎲 Rolling cube...');
    
    try {
        // Animate cube first
        await animateCube();
        
        // Then send transaction
        showStatus('🔄 Sending transaction...');
        
        const tx = await gameContract.playGame({
            gasLimit: 300000 // Set gas limit to avoid estimation issues
        });
        
        showStatus('⏳ Waiting for confirmation...');
        await tx.wait();
        
        // Check result
        const result = await gameContract.getLastResult(userAddress);
        const tokensWon = parseFloat(ethers.utils.formatUnits(result, 18));
        
        if (tokensWon > 0) {
            showStatus(`🎉 You won ${tokensWon} BASE tokens!`);
            createFireworks();
        } else {
            showStatus('😢 Better luck next time!');
        }
        
        await loadBalance();
        
    } catch (error) {
        console.error('Game error:', error);
        if (error.code === 4001) {
            showStatus('❌ Transaction cancelled');
        } else {
            showStatus('❌ Error: ' + error.message);
        }
    } finally {
        rollBtn.disabled = false;
    }
}

function animateCube() {
    return new Promise((resolve) => {
        const cube = document.getElementById('cube');
        let rotation = 0;
        
        function animate() {
            rotation += 20;
            cube.style.transform = `rotateX(${rotation}deg) rotateY(${rotation}deg)`;
            
            if (rotation < 720) {
                requestAnimationFrame(animate);
            } else {
                resolve();
            }
        }
        animate();
    });
}

function createFireworks() {
    const firework = document.getElementById('firework');
    const colors = ['#0052FF', '#0070FF', '#FFFFFF'];
    
    for (let i = 0; i < 30; i++) {
        const particle = document.createElement('div');
        particle.classList.add('particle');
        
        const angle = Math.random() * Math.PI * 2;
        const distance = 50 + Math.random() * 100;
        const tx = Math.cos(angle) * distance;
        const ty = Math.sin(angle) * distance;
        
        particle.style.left = '50%';
        particle.style.top = '50%';
        particle.style.background = colors[Math.floor(Math.random() * colors.length)];
        particle.style.setProperty('--tx', `${tx}px`);
        particle.style.setProperty('--ty', `${ty}px`);
        
        firework.appendChild(particle);
        setTimeout(() => particle.remove(), 1500);
    }
}

function showStatus(message) {
    let status = document.querySelector('.transaction-status');
    if (!status) {
        status = document.createElement('div');
        status.className = 'transaction-status';
        document.body.appendChild(status);
    }
    status.textContent = message;
    
    setTimeout(() => {
        if (status.parentNode) status.remove();
    }, 5000);
}

// Initialize when ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeGame);
} else {
    initializeGame();
}
  </script>
</body>
</html>
